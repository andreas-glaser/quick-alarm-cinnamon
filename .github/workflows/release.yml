name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  validate-version:
    name: Validate version format
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="${{ inputs.tag }}"
          fi

          if [[ "$TAG" != v* ]]; then
            echo "Error: tag must start with 'v' (got: $TAG)" >&2
            exit 1
          fi

          VERSION="${TAG#v}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must follow SemVer format (x.y.z). Got: $VERSION" >&2
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Releasing: $TAG"

  release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends gettext gjs zip

      - name: Validate changelog entry exists
        shell: bash
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          if ! grep -Eq "^## ${VERSION} " CHANGELOG.md; then
            echo "Error: No changelog entry found for ${VERSION} in CHANGELOG.md" >&2
            echo "Expected a heading like: \"## ${VERSION} - YYYY-MM-DD\"" >&2
            exit 1
          fi

      - name: Build and package
        run: |
          tools/build.sh
          tools/release.sh
          ls -la dist

      - name: Generate release notes
        shell: bash
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          awk -v version="$VERSION" '
            $0 ~ /^## / {
              if (found) exit
              if ($0 ~ "^## " version " ") { found=1; next }
            }
            found { print }
          ' CHANGELOG.md > release-notes.md

          if [[ ! -s release-notes.md ]]; then
            echo "Error: Failed to extract changelog notes for ${VERSION}" >&2
            exit 1
          fi

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-version.outputs.tag }}
          name: Release ${{ needs.validate-version.outputs.tag }}
          body_path: release-notes.md
          files: |
            dist/*.zip
          draft: false
          prerelease: false
